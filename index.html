<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Sitzplan – Mündliche Mitarbeit</title>
  <!-- Manifest verknüpfen -->
  <link rel="manifest" href="manifest.webmanifest">

  <!-- iOS-Icon / Statusbar-Farbe -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <meta name="theme-color" content="#2563eb">
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 1rem;
      background: #f3f4f6;
    }

    h1 {
      font-size: 1.6rem;
      margin-bottom: 0.5rem;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 1rem 1.25rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.06);
      margin-bottom: 1rem;
    }

    label {
      font-size: 0.9rem;
      font-weight: 500;
      display: block;
      margin-bottom: 0.25rem;
    }

    input, textarea, button, select {
      font-size: 0.95rem;
    }

    textarea, input {
      width: 100%;
      padding: 0.4rem 0.5rem;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      margin-bottom: 0.75rem;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px rgba(59,130,246,0.4);
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: flex-end;
    }

    .row > div {
      flex: 1;
      min-width: 150px;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 0.45rem 1rem;
      cursor: pointer;
      background: #2563eb;
      color: white;
      font-weight: 500;
      box-shadow: 0 10px 15px rgba(37,99,235,0.25);
      transition: transform 0.05s ease, box-shadow 0.1s ease;
      white-space: nowrap;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 25px rgba(37,99,235,0.35);
    }

    button:disabled {
      background: #9ca3af;
      box-shadow: none;
      cursor: not-allowed;
    }

    .seating-grid {
      margin-top: 1rem;
      display: grid;
      gap: 0.5rem;
      justify-content: flex-start;
    }

    .seat {
      background: #e5e7eb;
      border-radius: 10px;
      padding: 0.4rem 0.5rem;
      min-width: 110px;
      min-height: 70px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      cursor: pointer;
      position: relative;
      transition: transform 0.05s ease, box-shadow 0.1s ease, background 0.1s ease;
    }

    .seat.has-student {
      background: #eff6ff;
    }

    .seat:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.15);
    }

    .seat-name {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .seat-score {
      font-size: 0.85rem;
      margin-top: 0.2rem;
    }

    .seat-score span {
      font-weight: 600;
    }

    .seat-hint {
      font-size: 0.7rem;
      color: #6b7280;
      margin-top: 0.15rem;
    }

    .stats {
      font-size: 0.9rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }

    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 0.4rem 0.3rem;
      text-align: left;
    }

    th {
      background: #f9fafb;
      font-weight: 600;
    }

    .badge {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      background: #dbeafe;
      color: #1d4ed8;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .top-student {
      font-weight: 600;
      color: #16a34a;
    }

    .controls-inline {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.2rem;
    }

    .controls-inline button {
      box-shadow: none;
      font-size: 0.8rem;
      padding: 0.2rem 0.6rem;
    }

    .small {
      font-size: 0.8rem;
      color: #6b7280;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Sitzplan – Mündliche Mitarbeit</h1>
  <p class="small">
    Links Namen eingeben, Sitzplan erstellen, dann im Unterricht auf Plätze klicken:
    <strong>Linksklick = +1 Punkt</strong>, <strong>Rechtsklick = −1 Punkt</strong>.
  </p>

  <!-- Einstellungsbereich -->
  <div class="card">
    <div class="row">
      <div>
        <label for="names">Schüler:innen (ein Name pro Zeile)</label>
        <textarea id="names" rows="6" placeholder="Max Müller&#10;Lena Schmidt&#10;..."></textarea>
      </div>
      <div>
        <label for="rows">Anzahl Reihen</label>
        <input type="number" id="rows" min="1" value="4">
        <label for="cols">Anzahl Plätze pro Reihe</label>
        <input type="number" id="cols" min="1" value="5">
        <label for="layout">Belegung</label>
        <select id="layout">
          <option value="row">Reihenweise von vorne links</option>
          <option value="column">Spaltenweise</option>
        </select>

        <button id="buildPlanBtn" style="margin-top:0.5rem;">Sitzplan erstellen / aktualisieren</button>

        <p class="small" style="margin-top:0.5rem;">
          Sitzplan wird automatisch gespeichert (nur auf diesem Gerät/Browser).
        </p>
      </div>
    </div>
  </div>

  <!-- Sitzplan -->
  <div class="card">
    <h2 style="font-size:1.1rem; margin-top:0;">Sitzplan</h2>
    <div id="seatingGrid" class="seating-grid"></div>
  </div>

  <!-- Auswertung -->
  <div class="card">
    <h2 style="font-size:1.1rem; margin-top:0;">Auswertung</h2>
    <p class="stats" id="statsText">Noch keine Daten.</p>
    <div class="controls-inline">
      <button id="resetScoresBtn">Alle Punkte zurücksetzen</button>
      <button id="exportCsvBtn">CSV exportieren</button>
    </div>
    <table id="scoreTable" style="display:none;">
      <thead>
        <tr>
          <th>Platz</th>
          <th>Name</th>
          <th>Punkte</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
  // --- Datenmodell ---------------------------------------------------------
  let students = []; // { id, name, row, col, score }
  const STORAGE_KEY = "sitzplanMitarbeitV1";

  // --- DOM-Elemente --------------------------------------------------------
  const namesInput = document.getElementById("names");
  const rowsInput = document.getElementById("rows");
  const colsInput = document.getElementById("cols");
  const layoutSelect = document.getElementById("layout");
  const buildPlanBtn = document.getElementById("buildPlanBtn");
  const seatingGrid = document.getElementById("seatingGrid");
  const statsText = document.getElementById("statsText");
  const resetScoresBtn = document.getElementById("resetScoresBtn");
  const exportCsvBtn = document.getElementById("exportCsvBtn");
  const scoreTable = document.getElementById("scoreTable");
  const scoreTableBody = scoreTable.querySelector("tbody");

  // --- Hilfsfunktionen -----------------------------------------------------
  function saveToStorage() {
    const data = {
      students,
      rows: parseInt(rowsInput.value, 10),
      cols: parseInt(colsInput.value, 10),
      layout: layoutSelect.value,
      rawNames: namesInput.value
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function loadFromStorage() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    try {
      const data = JSON.parse(raw);
      if (data.students) students = data.students;
      if (data.rows) rowsInput.value = data.rows;
      if (data.cols) colsInput.value = data.cols;
      if (data.layout) layoutSelect.value = data.layout;
      if (data.rawNames) namesInput.value = data.rawNames;
    } catch (e) {
      console.warn("Konnte gespeicherte Daten nicht laden:", e);
    }
  }

  function buildStudentsFromNames() {
    const names = namesInput.value
      .split("\n")
      .map(n => n.trim())
      .filter(n => n.length > 0);

    const rows = parseInt(rowsInput.value, 10);
    const cols = parseInt(colsInput.value, 10);
    const layout = layoutSelect.value;

    const newStudents = [];
    let index = 0;

    if (layout === "row") {
      // Reihenweise: erst Reihe 1 von links nach rechts, dann Reihe 2 usw.
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          if (index >= names.length) break;
          newStudents.push({
            id: index,
            name: names[index],
            row: r,
            col: c,
            score: getOldScore(names[index]) // Punkte behalten, falls Name gleich
          });
          index++;
        }
      }
    } else {
      // Spaltenweise: erst Spalte 1 von vorne nach hinten, dann Spalte 2
      for (let c = 0; c < cols; c++) {
        for (let r = 0; r < rows; r++) {
          if (index >= names.length) break;
          newStudents.push({
            id: index,
            name: names[index],
            row: r,
            col: c,
            score: getOldScore(names[index])
          });
          index++;
        }
      }
    }

    students = newStudents;
  }

  function getOldScore(name) {
    const old = students.find(s => s.name === name);
    return old ? old.score : 0;
  }

  function renderSeatingGrid() {
    const rows = parseInt(rowsInput.value, 10);
    const cols = parseInt(colsInput.value, 10);

    seatingGrid.style.gridTemplateColumns = `repeat(${cols}, minmax(110px, 1fr))`;
    seatingGrid.innerHTML = "";

    for (let r = 0; r < rows; r++) {
      for (let c = 0; c < cols; c++) {
        const seat = document.createElement("div");
        seat.className = "seat";

        const student = students.find(s => s.row === r && s.col === c);
        if (student) {
          seat.classList.add("has-student");

          const nameEl = document.createElement("div");
          nameEl.className = "seat-name";
          nameEl.textContent = student.name;

          const scoreEl = document.createElement("div");
          scoreEl.className = "seat-score";
          scoreEl.innerHTML = `Punkte: <span>${student.score}</span>`;

          const hintEl = document.createElement("div");
          hintEl.className = "seat-hint";
          hintEl.textContent = "Links: +1, Rechts: -1";

          seat.appendChild(nameEl);
          seat.appendChild(scoreEl);
          seat.appendChild(hintEl);

          // Linksklick = +1
          seat.addEventListener("click", (e) => {
            e.preventDefault();
            updateScore(student, +1, scoreEl);
          });

          // Rechtsklick = -1
          seat.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            updateScore(student, -1, scoreEl);
          });
        } else {
          const emptyText = document.createElement("div");
          emptyText.className = "seat-hint";
          emptyText.textContent = "frei";
          seat.appendChild(emptyText);
        }

        seatingGrid.appendChild(seat);
      }
    }
  }

  function updateScore(student, delta, scoreElement) {
    student.score += delta;
    /*if (student.score < 0) student.score = 0; // keine negativen Punkte*/
    const span = scoreElement.querySelector("span");
    span.textContent = student.score;
    updateStats();
    saveToStorage();
  }

  function updateStats() {
    if (students.length === 0) {
      statsText.textContent = "Noch keine Daten.";
      scoreTable.style.display = "none";
      return;
    }

    const totalPoints = students.reduce((sum, s) => sum + s.score, 0);
    const avg = totalPoints / students.length;

    let maxScore = Math.max(...students.map(s => s.score));
    if (!isFinite(maxScore)) maxScore = 0;

    const topStudents = students
      .filter(s => s.score === maxScore && maxScore > 0)
      .map(s => s.name);

    let text = `Gesamtpunkte: ${totalPoints} · Durchschnitt: ${avg.toFixed(2)} Punkte pro Schüler:in.`;
    if (topStudents.length > 0) {
      text += ` Beste Mitarbeit: ${topStudents.join(", ")} (${maxScore} Punkte).`;
    }

    statsText.innerHTML = text;

    // Tabelle aktualisieren
    const sorted = [...students].sort((a, b) => b.score - a.score || a.name.localeCompare(b.name));
    scoreTableBody.innerHTML = "";
    sorted.forEach((s, idx) => {
      const row = document.createElement("tr");
      const rankCell = document.createElement("td");
      const nameCell = document.createElement("td");
      const scoreCell = document.createElement("td");

      rankCell.textContent = idx + 1;
      nameCell.textContent = s.name;
      scoreCell.textContent = s.score;

      if (s.score === maxScore && maxScore > 0) {
        nameCell.classList.add("top-student");
      }

      row.appendChild(rankCell);
      row.appendChild(nameCell);
      row.appendChild(scoreCell);

      scoreTableBody.appendChild(row);
    });
    scoreTable.style.display = "table";
  }

  function resetScores() {
    if (!confirm("Alle Mitarbeitspunkte wirklich zurücksetzen?")) return;
    students.forEach(s => s.score = 0);
    renderSeatingGrid();
    updateStats();
    saveToStorage();
  }

  function exportCsv() {
    if (students.length === 0) {
      alert("Keine Daten zum Exportieren.");
      return;
    }
    const lines = [];
    lines.push("Platz;Name;Punkte");
    const sorted = [...students].sort((a, b) => b.score - a.score || a.name.localeCompare(b.name));
    sorted.forEach((s, idx) => {
      lines.push(`${idx + 1};"${s.name.replace(/"/g, '""')}";${s.score}`);
    });
    const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "mündliche_mitarbeit_sitzplan.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // --- Event-Listener ------------------------------------------------------
  buildPlanBtn.addEventListener("click", () => {
    buildStudentsFromNames();
    renderSeatingGrid();
    updateStats();
    saveToStorage();
  });

  resetScoresBtn.addEventListener("click", resetScores);
  exportCsvBtn.addEventListener("click", exportCsv);

  // Beim Laden: Daten wiederherstellen
  loadFromStorage();
  renderSeatingGrid();
  updateStats();

  // Am Ende: Service Worker registrieren
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("service-worker.js")
        .catch(err => console.error("SW Registrierung fehlgeschlagen", err));
    });
  }
</script>
</body>
</html>
