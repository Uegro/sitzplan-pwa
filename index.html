<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Sitzplan – Mündliche Mitarbeit (PWA)</title>

  <!-- PWA: Manifest & iOS-Infos -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#2563eb">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      padding: 0.75rem;
      background: #f3f4f6;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto 3rem auto;
    }

    h1 {
      font-size: 1.6rem;
      margin: 0.25rem 0 0.5rem;
    }

    h2 {
      font-size: 1.15rem;
      margin: 0 0 0.5rem;
    }

    .small {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .card {
      background: white;
      border-radius: 14px;
      padding: 0.9rem 1rem;
      margin-top: 0.75rem;
      box-shadow: 0 12px 28px rgba(0,0,0,0.06);
    }

    label {
      font-size: 0.85rem;
      font-weight: 500;
      display: block;
      margin-bottom: 0.15rem;
    }

    input, textarea, select {
      width: 100%;
      font-size: 0.95rem;
      padding: 0.45rem 0.55rem;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      margin-bottom: 0.5rem;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.4);
    }

    textarea {
      resize: vertical;
      min-height: 110px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .row > div {
      flex: 1;
      min-width: 180px;
    }

    button {
      font-size: 0.9rem;
      border-radius: 999px;
      border: none;
      padding: 0.5rem 0.9rem;
      cursor: pointer;
      background: #2563eb;
      color: white;
      font-weight: 500;
      box-shadow: 0 10px 20px rgba(37,99,235,0.25);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.3rem;
      margin-right: 0.3rem;
      margin-bottom: 0.3rem;
    }

    button:active {
      transform: scale(0.98);
      box-shadow: 0 6px 14px rgba(37,99,235,0.35);
    }

    button.secondary {
      background: #e5e7eb;
      color: #111827;
      box-shadow: none;
    }

    button.danger {
      background: #dc2626;
      box-shadow: 0 10px 20px rgba(220,38,38,0.25);
      color: #fef2f2;
    }

    button.small {
      padding: 0.25rem 0.6rem;
      font-size: 0.8rem;
      border-radius: 999px;
      box-shadow: none;
    }

    button.icon {
      padding-inline: 0.5rem;
      width: 2rem;
      height: 2rem;
      border-radius: 999px;
    }

    .pill {
      display: inline-block;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .seating-grid {
      margin-top: 0.75rem;
      display: grid;
      gap: 0.5rem;
      justify-content: flex-start;
    }

    .seat {
      background: #f9fafb;
      border-radius: 12px;
      padding: 0.45rem 0.5rem;
      min-width: 130px;
      min-height: 96px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      border: 1px solid #e5e7eb;
      touch-action: manipulation;
    }

    .seat-name {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
      word-wrap: break-word;
    }

    .seat-counters {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .counter-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.15rem;
    }

    .counter-label {
      font-size: 0.8rem;
      font-weight: 500;
    }

    .counter-value {
      font-size: 0.85rem;
      min-width: 1.5rem;
      text-align: center;
    }

    .counter-buttons {
      display: inline-flex;
      gap: 0.1rem;
    }

    .btn-pos {
      background: #16a34a;
      color: #ecfdf3;
    }

    .btn-neg {
      background: #f97316;
      color: #fff7ed;
    }

    .btn-pos.small, .btn-neg.small {
      box-shadow: none;
    }

    .seat-empty {
      font-size: 0.8rem;
      color: #9ca3af;
      text-align: center;
      margin: auto;
    }

    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .badge {
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      background: #e5e7eb;
      font-size: 0.8rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.85rem;
    }

    th, td {
      padding: 0.35rem 0.3rem;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }

    th {
      background: #f9fafb;
      font-weight: 600;
    }

    .top-student {
      font-weight: 600;
      color: #16a34a;
    }

    .alert {
      font-size: 0.8rem;
      margin-top: 0.3rem;
    }

    .alert.ok {
      color: #15803d;
    }

    .alert.error {
      color: #b91c1c;
    }

    @media (max-width: 640px) {
      body {
        padding: 0.5rem;
      }
      .card {
        padding: 0.75rem 0.75rem;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Sitzplan – Mündliche Mitarbeit</h1>
  <p class="small">
    Für Tablets optimiert. Tippe auf die <strong>+ / − Knöpfe</strong> bei jeder Person, um
    <strong>positive</strong> und <strong>negative Beiträge getrennt</strong> zu zählen. Alles wird offline gespeichert.
  </p>

  <!-- Klassenverwaltung -->
  <div class="card">
    <h2>Klasse & Sitzplan</h2>
    <div class="row">
      <div>
        <label for="classSelect">Gespeicherte Klassen</label>
        <select id="classSelect"></select>

        <label for="className">Klassenname (z.B. 8a Deutsch)</label>
        <input id="className" type="text" placeholder="z.B. 8a Deutsch">

        <label for="names">Schüler:innen (ein Name pro Zeile)</label>
        <textarea id="names" placeholder="Max Müller&#10;Lena Schmidt&#10;..."></textarea>
      </div>
      <div>
        <label for="rows">Anzahl Reihen</label>
        <input id="rows" type="number" min="1" value="4">

        <label for="cols">Plätze pro Reihe</label>
        <input id="cols" type="number" min="1" value="5">

        <label for="layout">Belegung</label>
        <select id="layout">
          <option value="row">Reihenweise von vorne links</option>
          <option value="column">Spaltenweise</option>
        </select>

        <div style="margin-top:0.4rem;">
          <button id="buildPlanBtn">Sitzplan aus Namen erzeugen</button>
          <button id="saveClassBtn" class="secondary">Klasse speichern/aktualisieren</button>
          <button id="deleteClassBtn" class="secondary danger small">Klasse löschen</button>
        </div>
        <p class="small" style="margin-top:0.3rem;">
          Klassen & Sitzpläne werden lokal auf diesem Gerät gespeichert (kein Server).
        </p>

        <!-- NEU: Backup-Export/Import -->
        <div style="margin-top:0.4rem;">
          <button id="backupExportBtn" class="secondary">
            Backup (alle Klassen & Stunden) exportieren
          </button>
          <label class="small" style="display:block; margin-top:0.3rem;">
            Backup importieren (JSON):
            <input id="backupImportInput" type="file" accept=".json,application/json">
          </label>
        </div>


        <div id="classMessage" class="alert"></div>
      </div>
    </div>
  </div>

  <!-- Stunde -->
  <div class="card">
    <div class="flex-between">
      <h2>Aktuelle Stunde</h2>
      <div class="small">
        Aktuelle Klasse: <span id="currentClassLabel" class="pill">keine ausgewählt</span>
      </div>
    </div>

    <div class="row">
      <div>
        <label for="lessonDate">Datum</label>
        <input id="lessonDate" type="date">
      </div>
      <div>
        <label>&nbsp;</label>
        <div>
          <button id="newLessonBtn" class="secondary">Neue Stunde starten (Zähler auf 0)</button>
          <button id="saveLessonBtn">Stunde speichern</button>
        </div>
        <p class="small">
          „Neue Stunde“ setzt alle Beiträge dieser Klasse auf 0 (Sitzplan bleibt).
          „Stunde speichern“ legt einen Eintrag mit Datum & Ergebnissen an.
        </p>
        <div id="lessonMessage" class="alert"></div>
      </div>
    </div>
  </div>

  <!-- Sitzplan & Zähler -->
  <div class="card">
    <div class="flex-between">
      <h2>Sitzplan & Mitarbeit</h2>
      <span class="badge" id="seatInfoBadge">Noch kein Sitzplan.</span>
    </div>
    <div id="seatingGrid" class="seating-grid"></div>
  </div>

  <!-- Auswertung -->
  <div class="card">
    <h2>Auswertung – aktuelle Stunde</h2>
    <p id="statsText" class="small">Noch keine Daten.</p>
    <div style="margin-bottom:0.4rem;">
      <button id="resetCountersBtn" class="secondary">Alle Zähler auf 0 setzen</button>
      <button id="exportCurrentCsvBtn" class="secondary">CSV – aktuelle Stunde</button>
      <button id="exportAllCsvBtn" class="secondary">CSV – alle Stunden (Klasse)</button>
    </div>

    <table id="currentTable" style="display:none;">
      <thead>
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>Positiv</th>
          <th>Negativ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Gespeicherte Stunden -->
  <div class="card">
    <h2>Gespeicherte Stunden (aktuelle Klasse)</h2>
    <p class="small">
      Jede gespeicherte Stunde enthält die Summe aller positiven und negativen Beiträge.
    </p>
    <table id="sessionsTable" style="display:none;">
      <thead>
        <tr>
          <th>Datum/Zeit</th>
          <th>Positiv gesamt</th>
          <th>Negativ gesamt</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
  // ------------------ Datenmodell & Konstanten ----------------------

  const STORAGE_CLASSES = "sp_classes_v1";
  const STORAGE_SESSIONS = "sp_sessions_v1";

  let classes = [];  // { id, name, rows, cols, layout, students:[{name,row,col}] }
  let sessions = []; // { id, classId, className, dateIso, scores:[{name,pos,neg}] }

  let currentClassId = null;
  let students = []; // aktueller Sitzplan mit Zählern: {id,name,row,col,pos,neg}

  // ------------------ DOM-Elemente ---------------------------------

  const classSelect = document.getElementById("classSelect");
  const classNameInput = document.getElementById("className");
  const namesInput = document.getElementById("names");
  const rowsInput = document.getElementById("rows");
  const colsInput = document.getElementById("cols");
  const layoutSelect = document.getElementById("layout");

  const buildPlanBtn = document.getElementById("buildPlanBtn");
  const saveClassBtn = document.getElementById("saveClassBtn");
  const deleteClassBtn = document.getElementById("deleteClassBtn");
  const classMessage = document.getElementById("classMessage");
  const backupExportBtn = document.getElementById("backupExportBtn");
  const backupImportInput = document.getElementById("backupImportInput");


  const currentClassLabel = document.getElementById("currentClassLabel");
  const lessonDateInput = document.getElementById("lessonDate");
  const newLessonBtn = document.getElementById("newLessonBtn");
  const saveLessonBtn = document.getElementById("saveLessonBtn");
  const lessonMessage = document.getElementById("lessonMessage");

  const seatingGrid = document.getElementById("seatingGrid");
  const seatInfoBadge = document.getElementById("seatInfoBadge");

  const statsText = document.getElementById("statsText");
  const resetCountersBtn = document.getElementById("resetCountersBtn");
  const exportCurrentCsvBtn = document.getElementById("exportCurrentCsvBtn");
  const exportAllCsvBtn = document.getElementById("exportAllCsvBtn");
  const currentTable = document.getElementById("currentTable");
  const currentTableBody = currentTable.querySelector("tbody");

  const sessionsTable = document.getElementById("sessionsTable");
  const sessionsTableBody = sessionsTable.querySelector("tbody");

  // ------------------ Hilfsfunktionen: Storage ----------------------

  function loadFromStorage() {
    try {
      const clsRaw = localStorage.getItem(STORAGE_CLASSES);
      const sesRaw = localStorage.getItem(STORAGE_SESSIONS);
      classes = clsRaw ? JSON.parse(clsRaw) : [];
      sessions = sesRaw ? JSON.parse(sesRaw) : [];
    } catch (e) {
      console.warn("Konnte Daten nicht laden:", e);
      classes = [];
      sessions = [];
    }
  }

  function saveClasses() {
    localStorage.setItem(STORAGE_CLASSES, JSON.stringify(classes));
  }

  function saveSessions() {
    localStorage.setItem(STORAGE_SESSIONS, JSON.stringify(sessions));
  }

  // ------------------ Klassen-UI -----------------------------------

  function updateClassSelect() {
    classSelect.innerHTML = "";
    const def = document.createElement("option");
    def.value = "";
    def.textContent = "– Klasse wählen –";
    classSelect.appendChild(def);

    classes.forEach(cls => {
      const opt = document.createElement("option");
      opt.value = cls.id;
      opt.textContent = cls.name;
      classSelect.appendChild(opt);
    });

    if (currentClassId) {
      classSelect.value = currentClassId;
    }
  }

  function generateIdFromName(name) {
    return name.trim().toLowerCase().replace(/\s+/g, "_");
  }

  function showClassMessage(msg, ok = true) {
    classMessage.textContent = msg;
    classMessage.className = "alert " + (ok ? "ok" : "error");
    if (!msg) classMessage.className = "alert";
  }

  function showLessonMessage(msg, ok = true) {
    lessonMessage.textContent = msg;
    lessonMessage.className = "alert " + (ok ? "ok" : "error");
    if (!msg) lessonMessage.className = "alert";
  }

  // Sitzplan aus Namen neu bauen (Zähler bleiben, wenn Namen gleich)
  function buildStudentsFromNames() {
    const names = namesInput.value
      .split("\n")
      .map(n => n.trim())
      .filter(Boolean);

    const rows = parseInt(rowsInput.value, 10) || 1;
    const cols = parseInt(colsInput.value, 10) || 1;
    const layout = layoutSelect.value;

    const newStudents = [];
    let index = 0;

    function getOldEntryForName(name) {
      return students.find(s => s.name === name);
    }

    if (layout === "row") {
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          if (index >= names.length) break;
          const name = names[index];
          const old = getOldEntryForName(name);
          newStudents.push({
            id: index,
            name,
            row: r,
            col: c,
            pos: old ? old.pos : 0,
            neg: old ? old.neg : 0
          });
          index++;
        }
      }
    } else {
      for (let c = 0; c < cols; c++) {
        for (let r = 0; r < rows; r++) {
          if (index >= names.length) break;
          const name = names[index];
          const old = getOldEntryForName(name);
          newStudents.push({
            id: index,
            name,
            row: r,
            col: c,
            pos: old ? old.pos : 0,
            neg: old ? old.neg : 0
          });
          index++;
        }
      }
    }

    students = newStudents;
    renderSeatingGrid();
    updateStats();
  }

  // Klasse speichern/aktualisieren
  function saveCurrentClass() {
    const className = classNameInput.value.trim();
    if (!className) {
      showClassMessage("Bitte einen Klassenname eingeben.", false);
      return;
    }

    const rows = parseInt(rowsInput.value, 10) || 1;
    const cols = parseInt(colsInput.value, 10) || 1;
    const layout = layoutSelect.value;

    // Wenn kein aktuelles students-Array existiert, aus Text erzeugen
    if (!students || students.length === 0) {
      buildStudentsFromNames();
    }

    const classId = currentClassId || generateIdFromName(className);
    const plainStudents = students.map(s => ({
      name: s.name,
      row: s.row,
      col: s.col
    }));

    const existingIndex = classes.findIndex(c => c.id === classId);

    const newClassObj = {
      id: classId,
      name: className,
      rows,
      cols,
      layout,
      students: plainStudents
    };

    if (existingIndex >= 0) {
      classes[existingIndex] = newClassObj;
      showClassMessage("Klasse aktualisiert.");
    } else {
      classes.push(newClassObj);
      showClassMessage("Klasse gespeichert.");
    }

    currentClassId = classId;
    saveClasses();
    updateClassSelect();
    updateCurrentClassLabel();
    renderSessionsTable();
  }

  // Klasse laden
  function loadClassById(id) {
    const cls = classes.find(c => c.id === id);
    if (!cls) return;
    currentClassId = cls.id;
    classNameInput.value = cls.name;
    rowsInput.value = cls.rows;
    colsInput.value = cls.cols;
    layoutSelect.value = cls.layout;

    // Namen ins Textfeld generieren
    const sorted = [...cls.students].sort((a, b) =>
      a.row - b.row || a.col - b.col
    );
    namesInput.value = sorted.map(s => s.name).join("\n");

    // students mit Zählern initialisieren
    students = sorted.map((s, idx) => ({
      id: idx,
      name: s.name,
      row: s.row,
      col: s.col,
      pos: 0,
      neg: 0
    }));

    renderSeatingGrid();
    updateStats();
    updateCurrentClassLabel();
    renderSessionsTable();
    showClassMessage("");
  }

  function deleteCurrentClass() {
    if (!currentClassId) {
      showClassMessage("Keine Klasse ausgewählt.", false);
      return;
    }
    const cls = classes.find(c => c.id === currentClassId);
    const name = cls ? cls.name : currentClassId;
    if (!confirm(`Klasse "${name}" wirklich löschen? (Sitzplan bleibt lokal nur in dieser Sitzung geladen)`)) return;

    classes = classes.filter(c => c.id !== currentClassId);
    saveClasses();

    // auch Sessions dieser Klasse anzeigen, aber nicht löschen (könnte man auch löschen)
    currentClassId = null;
    classSelect.value = "";
    classNameInput.value = "";
    namesInput.value = "";
    students = [];
    renderSeatingGrid();
    updateStats();
    updateCurrentClassLabel();
    renderSessionsTable();
    showClassMessage(`Klasse "${name}" gelöscht.`);
  }

  function updateCurrentClassLabel() {
    if (!currentClassId) {
      currentClassLabel.textContent = "keine ausgewählt";
      return;
    }
    const cls = classes.find(c => c.id === currentClassId);
    currentClassLabel.textContent = cls ? cls.name : currentClassId;
  }

  // ------------------ Sitzplan Rendering & Zähler -------------------

  function renderSeatingGrid() {
    const rows = parseInt(rowsInput.value, 10) || 1;
    const cols = parseInt(colsInput.value, 10) || 1;

    seatingGrid.innerHTML = "";
    seatingGrid.style.gridTemplateColumns = `repeat(${cols}, minmax(130px, 1fr))`;

    if (!students || students.length === 0) {
      seatInfoBadge.textContent = "Kein Sitzplan – bitte Klasse wählen oder erstellen.";
    } else {
      seatInfoBadge.textContent = `${students.length} Schüler:innen im Plan`;
    }

    for (let r = 0; r < rows; r++) {
      for (let c = 0; c < cols; c++) {
        const seat = document.createElement("div");
        seat.className = "seat";

        const s = students.find(s => s.row === r && s.col === c);
        if (!s) {
          const empty = document.createElement("div");
          empty.className = "seat-empty";
          empty.textContent = "frei";
          seat.appendChild(empty);
        } else {
          const nameEl = document.createElement("div");
          nameEl.className = "seat-name";
          nameEl.textContent = s.name;

          const countersEl = document.createElement("div");
          countersEl.className = "seat-counters";

          const posRow = document.createElement("div");
          posRow.className = "counter-row";
          const posLabel = document.createElement("span");
          posLabel.className = "counter-label";
          posLabel.textContent = ""; /* "Positiv";*/
          const posVal = document.createElement("span");
          posVal.className = "counter-value";
          posVal.textContent = s.pos;
          const posBtns = document.createElement("div");
          posBtns.className = "counter-buttons";

          const posMinus = document.createElement("button");
          posMinus.className = "small btn-pos icon";
          posMinus.textContent = "−";
          posMinus.addEventListener("click", (e) => {
            e.preventDefault();
            adjustCounter(s, "pos", -1, posVal);
          });

          const posPlus = document.createElement("button");
          posPlus.className = "small btn-pos icon";
          posPlus.textContent = "+";
          posPlus.addEventListener("click", (e) => {
            e.preventDefault();
            adjustCounter(s, "pos", +1, posVal);
          });

          posBtns.appendChild(posMinus);
          posBtns.appendChild(posPlus);
          posRow.appendChild(posLabel);
          posRow.appendChild(posBtns);
          posRow.appendChild(posVal);

          const negRow = document.createElement("div");
          negRow.className = "counter-row";
          const negLabel = document.createElement("span");
          negLabel.className = "counter-label";
          negLabel.textContent = ""; /*"Negativ";*/
          const negVal = document.createElement("span");
          negVal.className = "counter-value";
          negVal.textContent = s.neg;
          const negBtns = document.createElement("div");
          negBtns.className = "counter-buttons";

          const negMinus = document.createElement("button");
          negMinus.className = "small btn-neg icon";
          negMinus.textContent = "−";
          negMinus.addEventListener("click", (e) => {
            e.preventDefault();
            adjustCounter(s, "neg", -1, negVal);
          });

          const negPlus = document.createElement("button");
          negPlus.className = "small btn-neg icon";
          negPlus.textContent = "+";
          negPlus.addEventListener("click", (e) => {
            e.preventDefault();
            adjustCounter(s, "neg", +1, negVal);
          });

          negBtns.appendChild(negMinus);
          negBtns.appendChild(negPlus);
          negRow.appendChild(negLabel);
          negRow.appendChild(negBtns);
          negRow.appendChild(negVal);

          countersEl.appendChild(posRow);
          countersEl.appendChild(negRow);

          seat.appendChild(nameEl);
          seat.appendChild(countersEl);
        }

        seatingGrid.appendChild(seat);
      }
    }
  }

  function adjustCounter(student, field, delta, valueElement) {
    if (field !== "pos" && field !== "neg") return;
    student[field] = Math.max(0, student[field] + delta); // keine negativen Werte
    valueElement.textContent = student[field];
    updateStats();
  }

  function resetCounters() {
    if (!students || students.length === 0) return;
    if (!confirm("Alle positiven und negativen Zähler dieser Klasse auf 0 setzen?")) return;
    students.forEach(s => {
      s.pos = 0;
      s.neg = 0;
    });
    renderSeatingGrid();
    updateStats();
  }

  // ------------------ Auswertung & Sessions ------------------------

  function updateStats() {
    if (!students || students.length === 0) {
      statsText.textContent = "Noch keine Daten.";
      currentTable.style.display = "none";
      return;
    }

    const totalPos = students.reduce((sum, s) => sum + s.pos, 0);
    const totalNeg = students.reduce((sum, s) => sum + s.neg, 0);
    const avgPos = totalPos / students.length;
    const avgNeg = totalNeg / students.length;

    const maxPos = Math.max(...students.map(s => s.pos), 0);
    const maxNeg = Math.max(...students.map(s => s.neg), 0);

    const topPos = students.filter(s => s.pos === maxPos && maxPos > 0).map(s => s.name);
    const topNeg = students.filter(s => s.neg === maxNeg && maxNeg > 0).map(s => s.name);

    let text = `Positiv gesamt: ${totalPos}, Ø pro Schüler: ${avgPos.toFixed(2)} · Negativ gesamt: ${totalNeg}, Ø: ${avgNeg.toFixed(2)}.`;
    if (topPos.length > 0) {
      text += ` Beste positive Mitarbeit: ${topPos.join(", ")} (${maxPos}).`;
    }
    if (topNeg.length > 0) {
      text += ` Auffällig negativ: ${topNeg.join(", ")} (${maxNeg}).`;
    }
    statsText.textContent = text;

    // Tabelle aktuelle Stunde
    const sorted = [...students].sort((a, b) => {
      // zuerst nach positiver Mitarbeit, dann nach Name
      const diff = b.pos - a.pos;
      if (diff !== 0) return diff;
      return a.name.localeCompare(b.name);
    });

    currentTableBody.innerHTML = "";
    sorted.forEach((s, idx) => {
      const tr = document.createElement("tr");
      const tdRank = document.createElement("td");
      const tdName = document.createElement("td");
      const tdPos = document.createElement("td");
      const tdNeg = document.createElement("td");

      tdRank.textContent = idx + 1;
      tdName.textContent = s.name;
      tdPos.textContent = s.pos;
      tdNeg.textContent = s.neg;

      if (s.pos === maxPos && maxPos > 0) {
        tdName.classList.add("top-student");
      }

      tr.appendChild(tdRank);
      tr.appendChild(tdName);
      tr.appendChild(tdPos);
      tr.appendChild(tdNeg);
      currentTableBody.appendChild(tr);
    });

    currentTable.style.display = "table";
  }

  function saveCurrentLesson() {
    if (!currentClassId) {
      showLessonMessage("Bitte zuerst eine Klasse auswählen/speichern.", false);
      return;
    }
    if (!students || students.length === 0) {
      showLessonMessage("Kein Sitzplan vorhanden.", false);
      return;
    }

    const cls = classes.find(c => c.id === currentClassId);
    const className = cls ? cls.name : currentClassId;

    let dateVal = lessonDateInput.value;
    if (!dateVal) {
      // Fallback: aktuelles Datum in ISO-Form
      const now = new Date();
      dateVal = now.toISOString().slice(0,16);
      lessonDateInput.value = dateVal;
    }

    // Nur Datum speichern (ohne Uhrzeit)
    const dateIso = new Date(dateVal).toISOString().split("T")[0];
    const sessionId = `${currentClassId}_${dateIso}`;

    const scores = students.map(s => ({
      name: s.name,
      pos: s.pos,
      neg: s.neg
    }));

    // Wenn es schon eine Session mit gleicher ID gibt -> überschreiben
    const existingIndex = sessions.findIndex(s => s.id === sessionId);
    const sessionObj = { id: sessionId, classId: currentClassId, className, dateIso, scores };

    if (existingIndex >= 0) {
      sessions[existingIndex] = sessionObj;
      showLessonMessage("Stunde aktualisiert.");
    } else {
      sessions.push(sessionObj);
      showLessonMessage("Stunde gespeichert.");
    }

    saveSessions();
    renderSessionsTable();
  }

  function renderSessionsTable() {
    if (!currentClassId) {
      sessionsTable.style.display = "none";
      sessionsTableBody.innerHTML = "";
      return;
    }

    const filtered = sessions
      .filter(s => s.classId === currentClassId)
      .sort((a, b) => new Date(b.dateIso) - new Date(a.dateIso));

    if (filtered.length === 0) {
      sessionsTable.style.display = "none";
      sessionsTableBody.innerHTML = "";
      return;
    }

    sessionsTable.style.display = "table";
    sessionsTableBody.innerHTML = "";

    filtered.forEach(s => {
      const totalPos = s.scores.reduce((sum, x) => sum + x.pos, 0);
      const totalNeg = s.scores.reduce((sum, x) => sum + x.neg, 0);
      const tr = document.createElement("tr");
      const tdDate = document.createElement("td");
      const tdPos = document.createElement("td");
      const tdNeg = document.createElement("td");

      const d = new Date(s.dateIso);
      const dateStr = d.toLocaleDateString("de-DE");
            tdDate.textContent = dateStr;
            tdPos.textContent = totalPos;
            tdNeg.textContent = totalNeg;

      tr.appendChild(tdDate);
      tr.appendChild(tdPos);
      tr.appendChild(tdNeg);
      sessionsTableBody.appendChild(tr);
    });
  }

  function newLesson() {
    if (!students || students.length === 0) {
      showLessonMessage("Kein Sitzplan vorhanden.", false);
      return;
    }
    if (!confirm("Neue Stunde starten? Alle Zähler (positiv/negativ) werden auf 0 gesetzt.")) return;
    students.forEach(s => {
      s.pos = 0;
      s.neg = 0;
    });
    renderSeatingGrid();
    updateStats();
    setLessonDateNow();
    showLessonMessage("Neue Stunde gestartet.", true);
  }

  function exportCurrentCsv() {
    if (!students || students.length === 0) {
      alert("Keine Daten für aktuelle Stunde.");
      return;
    }
    const clsName = currentClassLabel.textContent || "unbekannte_Klasse";
    const dateVal = lessonDateInput.value || "";
    const lines = [];
    lines.push(`Klasse;${clsName}`);
    lines.push(`Datum;${dateVal.split("T")[0]}`);
    lines.push("");
    lines.push("Platz;Name;Positiv;Negativ");

    const sorted = [...students].sort((a, b) => a.name.localeCompare(b.name));
    sorted.forEach((s, idx) => {
      lines.push(`${idx + 1};"${s.name.replace(/"/g, '""')}";${s.pos};${s.neg}`);
    });

    downloadCsv(lines.join("\n"), `mitarbeit_${clsName}_aktuelle_stunde.csv`);

    function exportBackup() {
      const data = {
        version: 1,
        exportedAt: new Date().toISOString(),
        classes,
        sessions
      };

      const json = JSON.stringify(data, null, 2);
      const today = new Date();
      const pad = (n) => String(n).padStart(2, "0");
      const fileDate = `${today.getFullYear()}-${pad(today.getMonth() + 1)}-${pad(today.getDate())}`;

      const blob = new Blob([json], { type: "application/json;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `mitarbeit_backup_${fileDate}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showClassMessage("Backup-Datei heruntergeladen.", true);
    }

    function importBackupFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const text = e.target.result;
          const data = JSON.parse(text);

          if (!data || !Array.isArray(data.classes) || !Array.isArray(data.sessions)) {
            showClassMessage("Backup-Datei hat nicht das erwartete Format.", false);
            return;
          }

          if (!confirm("Backup importieren? Dadurch werden vorhandene Klassen und Stunden überschrieben.")) {
            return;
          }

          classes = data.classes;
          sessions = data.sessions;

          saveClasses();
          saveSessions();

          updateClassSelect();
          renderSessionsTable();
          students = [];      // aktueller Sitzplan wird neu geladen, wenn du eine Klasse auswählst
          renderSeatingGrid();
          updateStats();
          currentClassId = null;
          updateCurrentClassLabel();

          showClassMessage("Backup importiert. Bitte Klasse auswählen.", true);
        } catch (err) {
          console.error(err);
          showClassMessage("Backup-Datei konnte nicht gelesen werden.", false);
        }
      };
      reader.readAsText(file);
    }

  }

  function exportAllSessionsCsv() {
    if (!currentClassId) {
      alert("Bitte zuerst eine Klasse auswählen.");
      return;
    }
    const filtered = sessions.filter(s => s.classId === currentClassId);
    if (filtered.length === 0) {
      alert("Für diese Klasse wurden noch keine Stunden gespeichert.");
      return;
    }

    const cls = classes.find(c => c.id === currentClassId);
    const className = cls ? cls.name : currentClassId;

    const lines = [];
    lines.push(`Klasse;${className}`);
    lines.push("");
    lines.push("Datum;Name;Positiv;Negativ");

    filtered.forEach(s => {
      const d = new Date(s.dateIso);
      const dateStr = d.toLocaleDateString("de-DE");
      s.scores.forEach(sc => {
        lines.push(
          `"${dateStr}";"${sc.name.replace(/"/g, '""')}";${sc.pos};${sc.neg}`
        );
      });
    });

    downloadCsv(lines.join("\n"), `mitarbeit_${className}_alle_stunden.csv`);
  }

  function downloadCsv(text, filename) {
    const blob = new Blob([text], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function setLessonDateNow() {
    const now = new Date();
    const pad = (n) => String(n).padStart(2, "0");
    const dateStr =
      now.getFullYear() +
      "-" + pad(now.getMonth() + 1) +
      "-" + pad(now.getDate());
    lessonDateInput.value = dateStr;
  }

  // ------------------ Event Listener --------------------------------

  classSelect.addEventListener("change", () => {
    const id = classSelect.value || null;
    if (!id) {
      currentClassId = null;
      updateCurrentClassLabel();
      showClassMessage("");
      return;
    }
    loadClassById(id);
  });

  buildPlanBtn.addEventListener("click", () => {
    buildStudentsFromNames();
    showClassMessage("Sitzplan aus Namen aktualisiert.");
  });

  saveClassBtn.addEventListener("click", () => {
    saveCurrentClass();
  });

  deleteClassBtn.addEventListener("click", () => {
    deleteCurrentClass();
  });

  newLessonBtn.addEventListener("click", () => {
    newLesson();
  });

  saveLessonBtn.addEventListener("click", () => {
    saveCurrentLesson();
  });

  resetCountersBtn.addEventListener("click", () => {
    resetCounters();
  });

  exportCurrentCsvBtn.addEventListener("click", () => {
    exportCurrentCsv();
  });

  exportAllCsvBtn.addEventListener("click", () => {
    exportAllSessionsCsv();
  });

  backupExportBtn.addEventListener("click", () => {
  exportBackup();
});

backupImportInput.addEventListener("change", (event) => {
  const file = event.target.files && event.target.files[0];
  if (!file) return;
  importBackupFile(file);
  // Auswahl zurücksetzen, damit du später die gleiche Datei erneut wählen kannst
  backupImportInput.value = "";
});

  // ------------------ Initialisierung -------------------------------

  function init() {
    loadFromStorage();
    updateClassSelect();
    updateCurrentClassLabel();
    setLessonDateNow();
    renderSeatingGrid();
    updateStats();
    renderSessionsTable();
  }

  init();

  // Service Worker registrieren (für PWA / Offline)
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("service-worker.js")
        .catch(err => console.error("Service Worker Registrierung fehlgeschlagen:", err));
    });
  }
</script>
</body>
</html>
